<dataConfig>
  <dataSource name="db" type="JdbcDataSource" driver="com.mysql.jdbc.Driver"
    url="jdbc:mysql://{{ default .Env.MYSQL_HOST "mysql" }}:{{ default .Env.MYSQL_PORT "3306" }}/{{ default .Env.MYSQL_DATABASE "datacite" }}" user="{{ .Env.MYSQL_USER }}"
    password="{{ .Env.MYSQL_PASSWORD }}" readonly="true"
    batchSize="-1" />
  <!-- for batchSize=-1 see DIH FAQ -->
  <dataSource name="field" type="FieldReaderDataSource" />
  <document>
    <!-- SOLR-2104 -->
    <!-- using delta import as proposed in http://wiki.apache.org/solr/DataImportHandlerDeltaQueryViaFullImport -->
    <entity name="dataset" dataSource="db"
      query="SELECT d.doi AS doi,
                    d.id AS dataset_id,
                    dc.symbol AS datacentre_symbol,
                    CONCAT(dc.symbol, ' - ', dc.name) AS datacentre,
                    al.symbol AS allocator_symbol,
                    CONCAT(al.symbol, ' - ', al.name) AS allocator,
                    IF(d.is_active, m.xml, NULL) as xml,
                    m.xml IS NOT NULL as has_metadata,
                    m.id as metadata_id,
   		    IF(d.is_active, m.dif, NULL) as dif,
                    m.dif IS NOT NULL as has_dif,
                    IF(d.is_active, m.iso, NULL) as iso,
                    m.iso IS NOT NULL as has_iso,
                    d.created AS created,
                    d.minted AS minted,
                    d.last_landing_page_status_check AS checked,
                    m.created AS uploaded,
                    CAST(GREATEST(d.updated, IFNULL(m.created,0)) AS DATETIME) AS updated,
                    m.namespace,
                    mt.dataset IS NOT NULL AS has_media,
                    d.is_active,
                    d.aasm_state AS state
             FROM dataset AS d
             LEFT JOIN metadata AS m ON m.dataset = d.id
    	       LEFT JOIN metadata mmax ON m.metadata_version &lt; mmax.metadata_version and m.dataset=mmax.dataset
             LEFT JOIN metadata AS mm ON mm.dataset = d.id
             LEFT JOIN media AS mt ON mt.dataset = d.id
             JOIN datacentre AS dc ON d.datacentre = dc.id
             JOIN allocator AS al ON dc.allocator = al.id
             WHERE d.doi NOT REGEXP '^${dataimporter.request.testprefix}/'
               AND d.minted IS NOT NULL
	       AND mmax.id is null
               AND ( '${dataimporter.request.clean}' != 'false'
                     OR GREATEST(d.updated,
                                 IFNULL(m.created,0),
                                 IFNULL(mt.updated,0),
                                 IFNULL(al.updated,0),
                                 IFNULL(dc.updated,0))
                        > '${dataimporter.last_index_time}' )
             GROUP BY dataset_id,m.id
"
      transformer="RegexTransformer">

      <field column="prefix" regex="([^/]*)/" sourceColName="doi" />

      <entity name="if_metadata" hasField="dataset.has_metadata"
        processor="org.datacite.search.handler.dataimport.ConditionalEntityProcessor"
        transformer="TemplateTransformer,RegexTransformer">
        <!-- order of transformer is important! -->

        <!-- schema_version detection table:

            has_metadata   namespace | schema_version
            =========================================
            false          <null>    | <null>
            true           <null>    | 2.0
            true           ...-x.y   | x.y
         -->
        <field column="namespace" template="${dataset.namespace}" />
            <!-- copy namespace to this entity;
                 hack for regextransformer for schema_version -->
        <field column="schema_version" regex="-(\d+(.\d+)*)$" sourceColName="namespace" template="2.0" />
            <!-- extract schema_version from namespace;
                 defaults to 2.0 if no namespace present -->

        <entity name="if_isactive" hasField="dataset.is_active"
          processor="org.datacite.search.handler.dataimport.ConditionalEntityProcessor">
          <!-- index xml only for active datasets -->
          <entity name="xml" dataSource="field" dataField="dataset.xml"
            forEach="/resource" processor="XPathEntityProcessor" onError="skip"
            transformer="org.datacite.search.handler.dataimport.KeyValueTransformer,org.datacite.search.handler.dataimport.TrimTransformer,org.datacite.search.handler.dataimport.LicenseTransformer">

            <field column="doisearch" xpath="//identifier" trim="true" />
            <field column="title" xpath="//title" trim="true" />
            <field column="titleType" xpath="//title/@titleType"/>
            <field column="creator" xpath="//creatorName" trim="true" />
            <field column="publisher" xpath="//publisher" trim="true" />
            <field column="publicationYear" xpath="//publicationYear" trim="true" />
            <field column="subject" xpath="//subject" trim="true" />
            <field column="subjectScheme" xpath="//subject/@subjectScheme" />
            <field column="contributor" xpath="//contributor/contributorName" trim="true" />
            <field column="contributorType" xpath="//contributor/@contributorType" />
            <field column="date" xpath="//date" trim="true" />
            <field column="dateType" xpath="//date/@dateType" />
            <field column="language" xpath="//language" trim="true" />
            <field column="resourceTypeGeneral" xpath="//resourceType/@resourceTypeGeneral" />
            <field column="resourceType" xpath="//resourceType" trim="true" />

            <field column="affiliation" xpath="//affiliation" trim="true" />

            <field column="type" xpath="//resourceType" trim="true" />
            <field column="type" xpath="//resourceType/@resourceTypeGeneral" />

            <field column="ignored_alternateIdentifier_type" xpath="//alternateIdentifier/@alternateIdentifierType" />
            <field column="ignored_alternateIdentifier" xpath="//alternateIdentifier" trim="true" />
            <field column="alternateIdentifier" keys="ignored_alternateIdentifier_type" values="ignored_alternateIdentifier" />

            <field column="ignored_relatedIdentifier_type" xpath="//relatedIdentifier/@relatedIdentifierType" />
            <field column="ignored_relatedIdentifier_relation" xpath="//relatedIdentifier/@relationType" />
            <field column="ignored_relatedIdentifier" xpath="//relatedIdentifier" trim="true" />
            <field column="ignored_relatedIdentifier_relation_and_type" keys="ignored_relatedIdentifier_relation" values="ignored_relatedIdentifier_type" />
            <field column="relatedIdentifier" keys="ignored_relatedIdentifier_relation_and_type" values="ignored_relatedIdentifier" />

            <field column="ignored_nameIdentifier_scheme" xpath="//nameIdentifier/@nameIdentifierScheme" />
            <field column="ignored_nameIdentifier" xpath="//nameIdentifier" trim="true" />
            <field column="nameIdentifier" keys="ignored_nameIdentifier_scheme" values="ignored_nameIdentifier" />

            <field column="size" xpath="//size" trim="true" />
            <field column="format" xpath="//format" trim="true" />
            <field column="version" xpath="//version" trim="true" />
            <field column="rights" xpath="//rights" trim="true" />
            <field column="rightsURI" xpath="//rights/@rightsURI" trim="true" />
            <field column="spdx" xpath="//rights/@rightsURI" license="true" />
            <field column="description" xpath="//description" trim="true" />
            <field column="descriptionType" xpath="//description/@descriptionType" />
            <field column="geoLocationPlace" xpath="//geoLocationPlace" trim="true" />

            <field column="ignored_funderIdentifier_type" xpath="//funderIdentifier/@funderIdentifierType" />
            <field column="ignored_funderIdentifier" xpath="//funderIdentifier" trim="true" />
            <field column="funderIdentifier" keys="ignored_funderIdentifier_type" values="ignored_funderIdentifier" />

            <field column="ignored_awardURI" xpath="//awardNumber/@awardURI" />
            <field column="ignored_awardNumber" xpath="//awardNumber" trim="true" />
            <field column="awardNumber" keys="ignored_awardURI" values="ignored_awardNumber" />
          </entity>

        <entity name="if_hasiso" hasField="dataset.has_iso"
          processor="org.datacite.search.handler.dataimport.ConditionalEntityProcessor">

          <entity name="sciencekeywords" dataSource="field" dataField="dataset.iso"
            forEach="/MD_Metadata/identificationInfo/MD_DataIdentification/" processor="XPathEntityProcessor" onError="continue"
            transformer="org.datacite.search.handler.dataimport.ScienceKeywordsTransformer,org.datacite.search.handler.dataimport.TrimTransformer">
            <field column="category" xpath="//keyword/CharacterString" trim="true" sciencekeytrans="true" position="2" />
          </entity>
<!--
		  <entity name="date" dataSource="field" dataField="dataset.iso"
		    forEach="/MD_Metadata/identificationInfo/MD_DataIdentification/extent/EX_Extent/temporalElement/"
		    processor="XPathEntityProcessor" onError="continue"
		    transformer="org.datacite.search.handler.dataimport.TrimTransformer">
		    <field column="startdate" xpath="//extent/TimePeriod/beginPosition" trim="true"  />
		    <field column="enddate" xpath="//extent/TimePeriod/endPosition" trim="true"  />
		  </entity>
-->

		  <entity name="sciencekeywords" dataSource="field" dataField="dataset.iso"
		    forEach="/MD_Metadata/identificationInfo/MD_DataIdentification/" processor="XPathEntityProcessor" onError="continue"
		    transformer="org.datacite.search.handler.dataimport.ScienceKeywordsTransformer,org.datacite.search.handler.dataimport.TrimTransformer">
		    <field column="classification" xpath="//keyword/CharacterString" trim="true" sciencekeytrans="true" position="3" />
		  </entity>

		  <entity name="sciencekeywords" dataSource="field" dataField="dataset.iso"
		    forEach="/MD_Metadata/identificationInfo/MD_DataIdentification/" processor="XPathEntityProcessor" onError="continue"
		    transformer="org.datacite.search.handler.dataimport.ScienceKeywordTreeTransformer,org.datacite.search.handler.dataimport.TrimTransformer">
		    <field column="sciencekeywordtree" xpath="//keyword/CharacterString" trim="true" sciencekeytreetrans="true" position="1"/>
		  </entity>

		  <entity name="sciencekeywords" dataSource="field" dataField="dataset.iso"
		    forEach="/MD_Metadata/identificationInfo/MD_DataIdentification/" processor="XPathEntityProcessor" onError="continue"
		    transformer="org.datacite.search.handler.dataimport.ScienceKeywordTreeTransformer,org.datacite.search.handler.dataimport.TrimTransformer">
		    <field column="sciencekeywordtree" xpath="//keyword/CharacterString" trim="true" sciencekeytreetrans="true" position="2"/>
		  </entity>

		  <entity name="sciencekeywords" dataSource="field" dataField="dataset.iso"
		    forEach="/MD_Metadata/identificationInfo/MD_DataIdentification/" processor="XPathEntityProcessor" onError="continue"
		    transformer="org.datacite.search.handler.dataimport.ScienceKeywordTreeTransformer,org.datacite.search.handler.dataimport.TrimTransformer">
		    <field column="sciencekeywordtree" xpath="//keyword/CharacterString" trim="true" sciencekeytreetrans="true" position="3"/>
		  </entity>

		  <entity name="sciencekeywords" dataSource="field" dataField="dataset.iso"
		    forEach="/MD_Metadata/identificationInfo/MD_DataIdentification/" processor="XPathEntityProcessor" onError="continue"
		    transformer="org.datacite.search.handler.dataimport.ScienceKeywordTreeTransformer,org.datacite.search.handler.dataimport.TrimTransformer">
		    <field column="sciencekeywordtree" xpath="//keyword/CharacterString" trim="true" sciencekeytreetrans="true" position="4"/>
		  </entity>

		  <entity name="sciencekeywords" dataSource="field" dataField="dataset.iso"
		    forEach="/MD_Metadata/identificationInfo/MD_DataIdentification/" processor="XPathEntityProcessor" onError="continue"
		    transformer="org.datacite.search.handler.dataimport.ScienceKeywordTreeTransformer,org.datacite.search.handler.dataimport.TrimTransformer">
		    <field column="sciencekeywordtree" xpath="//keyword/CharacterString" trim="true" sciencekeytreetrans="true" position="5"/>
		  </entity>

		  <entity name="sciencekeywords" dataSource="field" dataField="dataset.iso"
		    forEach="/MD_Metadata/identificationInfo/MD_DataIdentification/" processor="XPathEntityProcessor" onError="continue"
		    transformer="org.datacite.search.handler.dataimport.ScienceKeywordTreeTransformer,org.datacite.search.handler.dataimport.TrimTransformer">
		    <field column="sciencekeywordtree" xpath="//keyword/CharacterString" trim="true" sciencekeytreetrans="true" position="6"/>
		  </entity>
		  <entity name="sciencekeywords" dataSource="field" dataField="dataset.iso"
		    forEach="/MD_Metadata/identificationInfo/MD_DataIdentification/" processor="XPathEntityProcessor" onError="continue"
		    transformer="org.datacite.search.handler.dataimport.ScienceKeywordTreeTransformer,org.datacite.search.handler.dataimport.TrimTransformer">
		    <field column="sciencekeywordtree" xpath="//keyword/CharacterString" trim="true" sciencekeytreetrans="true" position="7"/>
		  </entity>

         </entity>
	 

        <entity name="geo" dataSource="field" dataField="dataset.xml"
             processor="GeoLocationsProcessor" onError="continue">
	    <field column="geo"  />	
       </entity>

        </entity>
      </entity>
      
      
      
      <entity name="if_media" hasField="dataset.has_media"
        processor="org.datacite.search.handler.dataimport.ConditionalEntityProcessor">
        <entity name="media" dataSource="db"
          query="SELECT CONCAT(media_type,':',url) AS media
               FROM media AS m
               WHERE m.dataset = '${dataset.dataset_id}'
              ">
        </entity>
      </entity>
    </entity>
  </document>
</dataConfig>
